/* In order to get first-touch attributions, we need to find the first time that a user interacted with our website. We do this by using a GROUP BY. Let’s call this table first_touch:

SELECT user_id,
   MIN(timestamp) AS 'first_touch_at'
FROM page_visits
GROUP BY user_id; */

/* First touch (first time website access) attribution query: 
WITH first_touch AS (
    SELECT user_id,
       MIN(timestamp) AS 'first_touch_at'
    FROM page_visits
    GROUP BY user_id)
SELECT ft.user_id,
   ft.first_touch_at,
   pv.utm_source
FROM first_touch AS 'ft'
JOIN page_visits AS 'pv'
   ON ft.user_id = pv.user_id
   AND ft.first_touch_at = pv.timestamp;*/

/* Using the query above as a guide, write the LAST-touch attribution query and run it. Make sure June’s last touch at 08:13:01 is still there by
adding a WHERE clause for user_id = 10069. */

WITH last_touch AS (SELECT user_id, Max(timestamp) AS 'last_touch_at' FROM page_visits Where user_id = 10069 GROUP BY user_id)
SELECT lt.user_id, lt.last_touch_at, pv.utm_source
FROM last_touch AS 'lt'
JOIN page_visits AS 'pv'
  ON lt.user_id = pv.user_id
  AND lt.last_touch_at = pv.timestamp;



/* PROJECT */



/* Page_visits Data table Columns: user_id, utm_source, utm_campaign, timestamp, page_name 
How many campaigns and sources does CoolTShirts use? Which source is used for each campaign? */
Select Count(Distinct utm_campaign) as utm_campaign_count, Count(Distinct utm_source) as utm_source_count from page_visits;
Select distinct utm_campaign, utm_source as utm_related from page_visits;

/* What pages are on the CoolTShirts website? */
Select distinct page_name from page_visits;

/* How many first touches is each campaign responsible for? */
WITH first_touch AS (SELECT user_id, Min(timestamp) AS 'first_touch_at' FROM page_visits GROUP BY utm_campaign) 
SELECT ft.user_id, ft.first_touch_at, pv.utm_campaign
FROM first_touch AS 'ft'
JOIN page_visits AS 'pv'
  ON ft.user_id = pv.user_id
  AND ft.first_touch_at = pv.timestamp;

/* How many last touches is each campaign responsible for? */
WITH last_touch AS (SELECT user_id, Max(timestamp) AS 'last_touch_at' FROM page_visits GROUP BY utm_campaign) 
SELECT lt.user_id, lt.last_touch_at, pv.utm_campaign
FROM last_touch AS 'lt'
JOIN page_visits AS 'pv'
  ON lt.user_id = pv.user_id
  AND lt.last_touch_at = pv.timestamp;

/* How many visitors made a purchase? */
Select count(distinct user_id) from page_visits where page_name = '4 - purchase';

/* How many last touches on the purchase page is each campaign responsible for? */
WITH last_touch AS (SELECT user_id, Max(timestamp) AS 'last_touch_at_before_purchase' FROM page_visits where page_name = '4 - purchase' GROUP BY utm_campaign) 
SELECT lt.user_id, lt.last_touch_at_before_purchase, pv.utm_campaign
FROM last_touch AS 'lt'
JOIN page_visits AS 'pv'
  ON lt.user_id = pv.user_id
  AND lt.last_touch_at_before_purchase = pv.timestamp;

/* How many visitors made a purchase for the campaigns above? */
Select utm_campaign as campaign_name, count(distinct user_id) as users_who_purchased from page_visits where page_name = '4 - purchase' and utm_campaign in (
        'retargetting-campaign',
        'ten-crazy-cool-tshirts-facts',
        'paid_search',
        'getting-to-know-cool-tshirts',
        'interview-with-cool-tshirts-founder',
        'weekly-newsletter',
        'cool-tshirts-search',
        'retargetting-ad')
    Group by utm_campaign order by users_who_purchased desc;

/* CoolTShirts can re-invest in 5 campaigns. Given your findings in the project, which should they pick and why? */
/* They should pick the top five campaigns visited the most before a purchase was made. By above table, this is:
weekly-newsletter, retargetting ad, retargetting campaign, ten crazy cool tshirt facts, and getting to know cool tshirts. */

